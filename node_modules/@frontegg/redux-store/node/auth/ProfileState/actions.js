"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var _helpers = require("../../helpers");
var _state = require("./state");
const _excluded = ["callback", "profilePictureUrl"];
var _default = (store, api, sharedActions) => {
  const actions = sharedActions;
  const setProfileState = state => {
    Object.assign(store.auth.profileState, state);
  };
  const resetProfileState = () => {
    (0, _helpers.deepResetState)(store, ['auth', 'profileState'], _state.initialState);
  };
  const loadProfile = async () => {
    setProfileState({
      loading: true
    });
    try {
      const profile = await (0, _helpers.retry)(api.teams.getProfile, 3, 2000);
      const currentUser = store.auth.user;
      actions.setUser((0, _extends2.default)({}, currentUser, profile));
      setProfileState({
        profile,
        loading: false
      });
    } catch (e) {
      setProfileState({
        loading: false,
        error: (0, _helpers.errorHandler)(e)
      });
    }
  };
  const updateEmail = async payload => {
    const {
      email,
      callback
    } = payload;
    setProfileState({
      saving: true,
      error: null,
      loading: true
    });
    try {
      await api.teams.updateEmail(email);
      setProfileState({
        saving: false,
        error: null,
        loading: false
      });
      callback == null ? void 0 : callback(true);
    } catch (e) {
      setProfileState({
        saving: false,
        error: (0, _helpers.errorHandler)(e),
        loading: false
      });
      callback == null ? void 0 : callback(null, e);
    }
  };
  const verifyEmail = async payload => {
    const {
      email,
      code,
      callback
    } = payload;
    setProfileState({
      saving: true,
      error: null,
      loading: true
    });
    try {
      await api.teams.verifyEmail(email, code);
      await actions.__refreshToken();
      setProfileState({
        saving: false,
        error: null,
        loading: false
      });
      callback == null ? void 0 : callback(true);
    } catch (e) {
      setProfileState({
        saving: false,
        error: (0, _helpers.errorHandler)(e),
        loading: false
      });
      callback == null ? void 0 : callback(null, e);
    }
  };
  const saveProfile = async _payload => {
    const {
        callback,
        profilePictureUrl
      } = _payload,
      payload = (0, _objectWithoutPropertiesLoose2.default)(_payload, _excluded);
    setProfileState({
      saving: true,
      error: null,
      loading: true
    });
    try {
      var _store$auth$profileSt;
      const oldProfileData = (_store$auth$profileSt = store.auth.profileState.profile) != null ? _store$auth$profileSt : {};
      let newProfilePictureUrl = oldProfileData.profilePictureUrl;
      if (profilePictureUrl !== oldProfileData.profilePictureUrl && profilePictureUrl) {
        const matchResult = (profilePictureUrl || '').match(/^data:image\/([A-Za-z-+\/]+);base64,(.+)$/);
        if (matchResult) {
          const profileImage = (0, _helpers.base64ToFormData)(profilePictureUrl, 'image');
          if (profileImage) {
            newProfilePictureUrl = await api.teams.updateProfileImage(profileImage);
            const imageTimeStamp = Date.now().toString();
            const urlTemplate = new URL(newProfilePictureUrl);
            urlTemplate.searchParams.set('t', imageTimeStamp);
            newProfilePictureUrl = urlTemplate.href;
          }
        }
      }
      const newProfileData = (0, _extends2.default)({}, oldProfileData, payload, {
        profilePictureUrl: newProfilePictureUrl
      });

      //TODO: change the payload type to IUpdateUserProfile which is the right type to send, currently we send more data then actually needed.
      const profile = await api.users.updateUserProfileV2(newProfileData);
      const currentUser = store.auth.user;
      actions.setUser((0, _extends2.default)({}, currentUser, profile));
      actions.setProfileState({
        profile,
        saving: false,
        loading: false
      });
      callback == null ? void 0 : callback(newProfileData);
    } catch (e) {
      setProfileState({
        saving: false,
        error: (0, _helpers.errorHandler)(e),
        loading: false
      });
      callback == null ? void 0 : callback(null, e);
    }
  };
  const changePassword = async payload => {
    setProfileState({
      loading: true
    });
    try {
      var _payload$callback;
      await api.teams.changePassword(payload);
      setProfileState({
        loading: false,
        error: undefined
      });
      (_payload$callback = payload.callback) == null ? void 0 : _payload$callback.call(payload, true);
    } catch (e) {
      var _payload$callback2;
      setProfileState({
        loading: false,
        error: (0, _helpers.errorHandler)(e)
      });
      (_payload$callback2 = payload.callback) == null ? void 0 : _payload$callback2.call(payload, null, e);
    }
  };
  return {
    setProfileState,
    resetProfileState,
    loadProfile,
    saveProfile,
    changePassword,
    updateEmail,
    verifyEmail
  };
};
exports.default = _default;