"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var _helpers = require("../../../helpers");
var _interfaces = require("../interfaces");
var _default = (store, api, sharedActions) => {
  const actions = sharedActions;

  /** @private */
  const __getInvitationLinkConfig = async retryConfig => {
    actions.setTeamError({
      key: _interfaces.TeamStateKeys.CONFIG_TOKEN_LINK,
      value: false
    });
    try {
      const invitationLinkConfig = await (0, _helpers.retryIfNeeded)(() => api.teams.getInviteLinkConfiguration(), retryConfig);
      actions.setTeamState({
        inviteTokenState: (0, _extends2.default)({}, invitationLinkConfig)
      });
    } catch (e) {
      actions.setTeamError({
        key: _interfaces.TeamStateKeys.CONFIG_TOKEN_LINK,
        value: (0, _helpers.errorHandler)(e)
      });
    }
  };
  const getInvitationLink = async payload => {
    actions.setTeamError({
      key: _interfaces.TeamStateKeys.GET_TOKEN_LINK,
      value: false
    });
    try {
      const retryConfig = payload == null ? void 0 : payload.retryConfig;
      await __getInvitationLinkConfig(retryConfig);
      const data = await (0, _helpers.retryIfNeeded)(() => api.teams.getInviteUserLink(), retryConfig);
      const {
        inviteTokenState
      } = store.auth.teamState;
      actions.setTeamState({
        inviteTokenState: (0, _extends2.default)({}, inviteTokenState, data)
      });
    } catch (e) {
      actions.setTeamError({
        key: _interfaces.TeamStateKeys.GET_TOKEN_LINK,
        value: (0, _helpers.errorHandler)(e)
      });
    }
  };
  const createInvitationLink = async payload => {
    const {
      callback
    } = payload;
    actions.setTeamError({
      key: _interfaces.TeamStateKeys.CREATE_TOKEN_LINK,
      value: false
    });
    const {
      inviteTokenState
    } = store.auth.teamState;
    try {
      const data = await api.teams.createInviteUserLink({
        expiresInMinutes: 43200
      });
      actions.setTeamState({
        inviteTokenState: (0, _extends2.default)({}, inviteTokenState, data)
      });
      callback == null ? void 0 : callback(data.token);
    } catch (e) {
      callback == null ? void 0 : callback(null, e);
      actions.setTeamError({
        key: _interfaces.TeamStateKeys.CREATE_TOKEN_LINK,
        value: (0, _helpers.errorHandler)(e)
      });
    }
  };
  const updateInvitationLink = async payload => {
    const {
      callback,
      expiresInMinutes,
      shouldSendEmail
    } = payload;
    actions.setTeamError({
      key: _interfaces.TeamStateKeys.UPDATE_TOKEN_LINK,
      value: false
    });
    try {
      const {
        inviteTokenState
      } = store.auth.teamState;
      const data = await api.teams.updateInviteUserLink({
        expiresInMinutes,
        shouldSendEmail
      });
      actions.setTeamState({
        inviteTokenState: (0, _extends2.default)({}, inviteTokenState, data)
      });
      callback == null ? void 0 : callback(true);
    } catch (e) {
      callback == null ? void 0 : callback(null, e);
      actions.setTeamError({
        key: _interfaces.TeamStateKeys.UPDATE_TOKEN_LINK,
        value: (0, _helpers.errorHandler)(e)
      });
    }
  };
  const deleteInvitationLink = async payload => {
    const {
      callback
    } = payload != null ? payload : {};
    actions.setTeamError({
      key: _interfaces.TeamStateKeys.DELETE_TOKEN_LINK,
      value: false
    });
    try {
      await api.teams.deleteInviteUserLink();
      actions.setTeamState({
        inviteTokenState: undefined
      });
      callback == null ? void 0 : callback(true);
    } catch (e) {
      actions.setTeamError({
        key: _interfaces.TeamStateKeys.DELETE_TOKEN_LINK,
        value: (0, _helpers.errorHandler)(e)
      });
      callback == null ? void 0 : callback(false, e);
    }
  };
  return {
    getInvitationLink,
    createInvitationLink,
    updateInvitationLink,
    deleteInvitationLink
  };
};
exports.default = _default;